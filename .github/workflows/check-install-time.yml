# GitHub Action to check for slow npm dependencies
# Add this to your repository's .github/workflows/ directory

name: Check Install Time

on:
  pull_request:
    paths:
      - 'package.json'
      - 'package-lock.json'
      - 'yarn.lock'
      - 'pnpm-lock.yaml'

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Analyze slow dependencies
        id: analyze
        run: |
          npx npm-why-slow@latest --json > analysis.json

          # Extract key metrics
          SLOW_COUNT=$(jq '.slowPackages | length' analysis.json)
          TOTAL_TIME=$(jq '.estimatedTotalTime' analysis.json)

          echo "slow_count=$SLOW_COUNT" >> $GITHUB_OUTPUT
          echo "total_time=$TOTAL_TIME" >> $GITHUB_OUTPUT

          # Display results
          npx npm-why-slow@latest

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const analysis = JSON.parse(fs.readFileSync('analysis.json', 'utf8'));

            let body = '## ðŸ“Š npm-why-slow Analysis\n\n';

            if (analysis.slowPackages.length === 0) {
              body += 'âœ… **No slow packages detected!** Your dependencies look optimized.\n';
            } else {
              body += `âš ï¸ Found **${analysis.slowPackages.length}** slow package(s) adding ~**${analysis.estimatedTotalTime}s** to install time.\n\n`;
              body += '| Package | Est. Time | Reason |\n';
              body += '|---------|-----------|--------|\n';

              for (const pkg of analysis.slowPackages.slice(0, 10)) {
                body += `| ${pkg.name} | ~${pkg.estimatedTime}s | ${pkg.reason} |\n`;
              }

              if (analysis.suggestions.length > 0) {
                body += '\n### ðŸ’¡ Suggestions\n\n';
                for (const s of analysis.suggestions.slice(0, 5)) {
                  const icon = s.priority === 'high' ? 'ðŸ”¥' : s.priority === 'medium' ? 'âš¡' : 'ðŸ’¡';
                  body += `- ${icon} ${s.suggestion}\n`;
                }
              }
            }

            body += '\n---\n*Analyzed by [npm-why-slow](https://github.com/willzhangfly/npm-why-slow)*';

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Fail if too slow
        if: ${{ steps.analyze.outputs.total_time > 120 }}
        run: |
          echo "::error::Install time exceeds 2 minutes threshold"
          exit 1
